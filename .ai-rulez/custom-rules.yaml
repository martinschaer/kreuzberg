# Kreuzberg Custom Rules
# Document extraction framework with OCR, plugin system, and intelligent caching
#
# Schema: ai-rules-v3
# Integration: Extends shared ai-rulez rules for document extraction domain
# Last Updated: 2025-12-29

---

# =============================================================================
# CORE ARCHITECTURE RULES
# =============================================================================

rules:

  - name: extraction-pipeline-architecture
    priority: critical
    description: |
      Routes documents: detection -> selection -> conversion -> post-processing -> caching.
      MIME detection: extension -> magic bytes -> content analysis.
      Legacy DOC/PPT -> DOCX/PPTX via LibreOffice. Priority-based extractor registry
      with fallback chain. Content-based cache keys with config-inclusive invalidation.

    scope:
      - ExtractionConfig cascade through pipeline
      - MIME type detection and routing
      - Extractor registration and fallback

  - name: plugin-system-abstraction
    priority: critical
    description: |
      All plugins implement standardized traits (Send + Sync) with async support
      and lifecycle management. Registered dynamically with priority arbitration.
      Registry: Arc<RwLock<>> with MIME type indexing for O(log n) lookup.
      Priority 0-255: higher selected first, fallback on failure.

    scope:
      - Trait-based plugin design
      - Thread-safe registry operations
      - Priority-based selection and fallback

  - name: cache-first-extraction-strategy
    priority: high
    description: |
      Check cache before extraction. Key: blake3(document_bytes + config_json).
      Invalidate on breaking config changes. Track hit rates per format.
      Store with extraction time, extractor name, quality metrics.

    scope:
      - Cache key generation strategy
      - Hit/miss tracking and metrics
      - Cache invalidation triggers

  - name: async-await-consistency
    priority: high
    description: |
      Primary APIs async. Sync wrappers use global Tokio runtime only.
      No blocking I/O in async contexts. Batch ops use concurrent execution
      with CancellationToken. Configurable per-operation timeouts.

    scope:
      - Async/await API design
      - Synchronous wrapper implementation
      - Batch processing concurrency

  - name: error-handling-and-recovery
    priority: high
    description: |
      Graceful fallback extraction chains. Preserve partial results when possible.
      Structured errors (thiserror) with context, root cause, recovery suggestions.
      Batch ops continue on per-document failure. Sanitized logging (no full paths).

    scope:
      - Error type hierarchy (ExtractionError, FormatError, ConfigError)
      - Fallback chain implementation
      - Partial result preservation

  - name: configuration-cascade-pattern
    priority: high
    description: |
      Single ExtractionConfig controls all behavior. No code changes for config
      changes. Validate config values before extraction. Sections: MimeConfig,
      OcrConfig, PostProcessorConfig, CacheConfig.

    scope:
      - ExtractionConfig structure design
      - Config validation and defaults
      - Config impact on extractor behavior

# =============================================================================
# OCR INTEGRATION RULES
# =============================================================================

  - name: ocr-backend-pluggability
    priority: critical
    description: |
      OCR backends interchangeable via OcrBackend trait. Tesseract via C FFI
      (kreuzberg-tesseract), EasyOCR/PaddleOCR via PyO3 with GIL management.
      Backend failures isolated. Graceful degradation to fallback backend.

    scope:
      - OcrBackend trait design
      - Tesseract C FFI integration
      - GIL management in async code

  - name: hocr-parsing-and-table-extraction
    priority: high
    description: |
      Parse hOCR XML for bounding boxes, confidence scores, formatting.
      Reconstruct tables via spatial clustering from word positions.
      Output clean GFM Markdown tables with alignment.

    scope:
      - hOCR XML structure validation
      - Coordinate and confidence parsing
      - Table cell boundary detection

  - name: image-preprocessing-pipeline
    priority: high
    description: |
      Conditional preprocessing based on image analysis. Upscale <150 DPI,
      downsample extreme high-res. Noise reduction and contrast enhancement
      (CLAHE) only when needed. Format-specific handling (PNG transparency, etc.).

    scope:
      - Image quality analysis
      - Conditional preprocessing steps
      - Format-specific handling

  - name: tesseract-native-integration
    priority: critical
    description: |
      Native Tesseract via C FFI (kreuzberg-tesseract). All PSM modes 0-13
      configurable per-document. hOCR always requested for analysis.
      Language pack validation before use.

    scope:
      - C FFI safety and error handling
      - PSM mode configuration
      - Language pack management

  - name: language-detection-and-support
    priority: high
    description: |
      Identify text languages from OCR output. Multi-language documents with
      per-region language specification. Handle script mixing (Latin + CJK).
      Fallback to config-specified languages if detection fails.

    scope:
      - Language detection algorithm
      - Multi-language document handling
      - Language pack validation

# =============================================================================
# PLUGIN SYSTEM RULES
# =============================================================================

  - name: format-specific-extractor-plugins
    priority: high
    description: |
      Each DocumentExtractor handles specific formats (PDF, DOCX, XLSX, PPTX).
      Clear MIME type declaration. Handle format-specific edge cases (encryption,
      corruption). Return standardized ExtractionResult.

    scope:
      - Format detection and routing
      - Format-specific extraction logic
      - Extractor fallback chain

  - name: post-processor-chaining
    priority: medium
    description: |
      Post-processors applied sequentially by priority. Failures isolated
      (don't block others). Track applied plugins in result metadata.
      Maintain ExtractionResult invariants throughout chain.

    scope:
      - Post-processor ordering and execution
      - Error handling during chaining
      - Result modification safety

  - name: validator-plugin-quality-control
    priority: medium
    description: |
      Validators run quality checks without blocking extraction.
      Generate ValidationReport with issues and recommendations.
      Metrics: text density, metadata coverage, structure quality.

    scope:
      - Quality metric calculation
      - Issue detection patterns
      - Report structure design

  - name: python-plugin-dynamic-discovery
    priority: medium
    description: |
      Discover Python plugins by scanning module paths for protocol-implementing
      classes. Validate required methods and signatures before registration.
      Graceful failure on discovery errors.

    scope:
      - Module discovery patterns
      - Plugin protocol validation
      - Error recovery

# =============================================================================
# PERFORMANCE & CACHING
# =============================================================================

  - name: telemetry-and-observability
    priority: high
    description: |
      OpenTelemetry spans for extraction, format detection, per-format handling.
      Metrics: duration, file size, cache hit/miss, format distribution.
      Path sanitization: filename only, no full paths.

    scope:
      - Span instrumentation
      - Metric collection
      - Log sanitization

  - name: concurrent-batch-optimization
    priority: high
    description: |
      Batch extraction with configurable worker pool (default: num_cpus * 2).
      Arc<DashMap> for shared state. Per-document error isolation.
      Results maintain input order.

    scope:
      - Worker pool configuration
      - Concurrent execution coordination
      - Error handling in batch mode

  - name: memory-efficiency-streaming
    priority: high
    description: |
      Stream large PDFs (>1GB) when possible. Clear temporary buffers promptly.
      Arc<> for shared data structures. Adjustable buffer sizes.

    scope:
      - Streaming extraction APIs
      - Buffer lifecycle management
      - Large document handling
