rules:
  # Plugin Architecture Rules
  - name: Trait-Based Plugin Design
    description: All plugins must implement standardized trait interfaces
    guidance: |
      - Every plugin implements base Plugin trait
      - Type-specific traits (DocumentExtractor, OcrBackend, PostProcessor, Validator)
      - Traits define clear contracts for plugin behavior
      - Async trait support for non-blocking operations
      - Optional lifecycle methods (initialize, shutdown)
    enforcement: Code review enforces trait implementation

  - name: Thread Safety Requirement
    description: All plugins must be Send + Sync for concurrent execution
    guidance: |
      - Plugin implementations must be thread-safe
      - Use Arc for shared state
      - Protect mutable state with locks (RwLock, Mutex)
      - Avoid thread-local storage in plugins
      - Test thread safety with concurrent access
    enforcement: Compiler enforces Send + Sync traits

  - name: Plugin Isolation
    description: Plugins must not depend on or interfere with each other
    guidance: |
      - Plugins have independent initialization
      - Plugin failures don't affect other plugins
      - Shared resources (cache, config) properly synchronized
      - No implicit plugin ordering dependencies
      - Graceful handling of missing plugins
    enforcement: Plugin isolation tests, dependency analysis

  - name: Lifecycle Management
    description: Properly implement plugin lifecycle
    guidance: |
      - Plugin::initialize() called once at registration
      - Plugin::shutdown() called at unregistration
      - Resources allocated in initialize()
      - Resources released in shutdown()
      - Handle lifecycle errors gracefully
      - Document initialization requirements
    enforcement: Lifecycle tests, resource leak detection

  # Registry Management Rules
  - name: Registry Thread Safety
    description: Registries must support concurrent access
    guidance: |
      - Use Arc<RwLock<>> for registry storage
      - Read operations use read locks
      - Write operations use write locks
      - No deadlock possibilities
      - Minimize lock hold times
      - Test concurrent registry operations
    enforcement: Concurrent registry tests, deadlock detection

  - name: Registry Consistency
    description: Maintain registry consistency across operations
    guidance: |
      - Register and indices stay synchronized
      - MIME type index updated with registrations
      - Unregister removes from index atomically
      - Query results reflect current registry state
      - Clear operations empty all data structures
    enforcement: Registry invariant tests

  - name: Efficient Lookups
    description: Optimize plugin selection performance
    guidance: |
      - O(log n) MIME type lookup via indexing
      - O(n) priority sorting (acceptable for small plugin counts)
      - Cache registry queries when appropriate
      - Avoid O(n) operations in hot paths
      - Profile and optimize lookup performance
    enforcement: Performance benchmarks for registry operations

  - name: Dynamic Registration
    description: Support runtime plugin registration/unregistration
    guidance: |
      - Plugins can be registered after initialization
      - Plugins can be unregistered without restart
      - Unregistration safe if plugin in use
      - Clear() removes all plugins atomically
      - Document registration/unregistration flow
    enforcement: Dynamic registration tests

  # Priority System Rules
  - name: Priority-Based Selection
    description: Use priority to arbitrate between multiple plugins
    guidance: |
      - Higher priority plugins selected first (255 = highest)
      - Fallback to lower priority on failure
      - Default priority is 50 (middle)
      - Custom extractors use priority > 50
      - Fallback implementations use priority < 50
    enforcement: Priority selection tests, fallback verification

  - name: Conflict Resolution
    description: Resolve conflicts between plugins claiming same capability
    guidance: |
      - Multiple extractors can support same MIME type
      - Highest-priority extractor attempted first
      - Failed extractor triggers fallback
      - Priority determines arbitration consistently
      - Document priority-based decisions in logs
    enforcement: Conflict resolution tests

  - name: Priority Stability
    description: Maintain consistent priority semantics
    guidance: |
      - Priority values documented in API
      - Priority ranges defined and stable
      - Breaking changes to priority system require major version
      - Provide migration path for priority changes
      - Test priority arbitration thoroughly
    enforcement: Stability tests, version policy enforcement

  # DocumentExtractor Plugin Rules
  - name: Format-Specific Extractors
    description: Each extractor handles specific document formats
    guidance: |
      - Implement for single or related MIME types
      - Declare supported MIME types clearly
      - Return accurate mime_type in results
      - Handle format-specific edge cases
      - Document format limitations
    enforcement: Format coverage tests, integration with extraction pipeline

  - name: Extractor Configuration
    description: Respect ExtractionConfig in extraction behavior
    guidance: |
      - Read relevant config sections
      - Apply config options to customize behavior
      - Validate config before use
      - Handle invalid config gracefully
      - Document config impact on output
    enforcement: Config tests with various settings

  - name: Consistent Result Format
    description: Return standardized ExtractionResult from all extractors
    guidance: |
      - Populate all relevant ExtractionResult fields
      - Include metadata, tables, images as applicable
      - Use consistent text encoding (UTF-8)
      - Document result field meanings
      - Validate result structure
    enforcement: Result schema validation

  - name: Error Handling in Extractors
    description: Handle errors and provide recovery options
    guidance: |
      - Return meaningful error types
      - Include error context for debugging
      - Suggest fallback extractors
      - Never panic, always return Result
      - Log detailed error information
    enforcement: Error handling tests, fallback verification

  # OCR Backend Plugin Rules
  - name: OCR Backend Interface
    description: Implement OcrBackend trait completely
    guidance: |
      - Implement async process_image()
      - Return supported_languages()
      - Declare capabilities()
      - Handle all image formats
      - Support configurable languages
    enforcement: Trait implementation tests

  - name: Async Execution
    description: Support non-blocking async OCR execution
    guidance: |
      - Implement async process_image() trait
      - Don't block async runtime
      - For sync Python backends, use tokio::task::spawn_blocking
      - Handle timeouts gracefully
      - Return results asynchronously
    enforcement: Async execution tests, runtime analysis

  - name: Language Support Declaration
    description: Accurately declare language support
    guidance: |
      - List all supported languages
      - Use standard language codes (ISO 639-1)
      - Document language limitations
      - Handle unsupported languages gracefully
      - Test declared language support
    enforcement: Language support tests

  - name: Capability Declaration
    description: Declare OCR capabilities accurately
    guidance: |
      - Declare table detection support
      - Declare hOCR output support
      - Declare confidence score support
      - Declare minimum resolution requirements
      - Test declared capabilities
    enforcement: Capability testing

  # Python Plugin Rules
  - name: Python Plugin Protocol
    description: Define Python plugin interface clearly
    guidance: |
      - Class-based plugin definition
      - Required methods documented
      - Type hints for methods
      - Async method support
      - Exception handling documented
    enforcement: Python plugin documentation, example implementations

  - name: GIL Management
    description: Manage Python Global Interpreter Lock efficiently
    guidance: |
      - Python::attach() for quick operations
      - py.detach() for expensive Rust operations
      - tokio::task::spawn_blocking() for async Python calls
      - Cache Python data in Rust fields
      - Minimize GIL hold times
    enforcement: GIL management code reviews, performance profiling

  - name: Python Exception Handling
    description: Translate Python exceptions to Rust errors
    guidance: |
      - Catch PyException and convert to KreuzbergError
      - Include Python error message in Rust error
      - Log Python tracebacks for debugging
      - Handle import errors gracefully
      - Document expected Python exceptions
    enforcement: Python error handling tests

  - name: Python Data Type Mapping
    description: Correctly map between Python and Rust types
    guidance: |
      - String ↔ str
      - Bytes ↔ [u8]
      - List ↔ Vec<>
      - Dict ↔ HashMap
      - Validate type conversions
      - Handle conversion errors
    enforcement: Type mapping tests, PyO3 best practices

  # Post-Processor Plugin Rules
  - name: Result Enhancement
    description: Implement post-processors for result enhancement
    guidance: |
      - Modify ExtractionResult in-place
      - Support configuration via PostProcessorConfig
      - Document enhancement behavior
      - Preserve original data
      - Handle enhancement failures gracefully
    enforcement: Post-processor tests, result validation

  - name: Plugin Chaining
    description: Support sequential post-processor execution
    guidance: |
      - Plugins applied in priority order
      - Each plugin modifies result for next
      - Failures don't prevent other plugins
      - Track which plugins were applied
      - Maintain result structure throughout chain
    enforcement: Chaining tests, result integrity validation

  # Validator Plugin Rules
  - name: Content Validation
    description: Implement quality checks and validation
    guidance: |
      - Validate extraction quality
      - Generate detailed ValidationReport
      - Include issue detection and recommendations
      - Don't block extraction (quality control)
      - Document validation criteria
    enforcement: Validation tests, report format validation

  # Discovery & Loading Rules
  - name: Static Rust Plugin Registration
    description: Register Rust plugins directly via code
    guidance: |
      - Instantiate plugin struct
      - Call register_* function
      - Handle registration errors
      - Store plugin reference
      - Document registration process
    enforcement: Registration code reviews

  - name: Python Plugin Discovery
    description: Dynamically discover Python plugins
    guidance: |
      - Scan module paths for plugin classes
      - Detect classes implementing plugin protocol
      - Validate before registration
      - Handle discovery errors
      - Document plugin module structure
    enforcement: Discovery tests, plugin validation

  - name: Plugin Validation
    description: Validate plugins before registration
    guidance: |
      - Check trait implementation
      - Verify required methods exist
      - Check method signatures
      - Validate configuration schema
      - Test plugin initialization
    enforcement: Validation tests, registration guards

  # Performance & Optimization Rules
  - name: Performance Baseline
    description: Establish and maintain performance baselines
    guidance: |
      - Benchmark plugin registration overhead
      - Benchmark plugin selection overhead
      - Benchmark plugin execution overhead
      - Track performance trends
      - Optimize critical paths
    enforcement: Performance benchmarks, CI/CD tracking

  - name: GIL Performance Optimization
    description: Minimize GIL overhead in Python plugins
    guidance: |
      - Profile GIL usage (typical: 5-55µs per call)
      - Cache frequently-accessed Python data
      - Minimize GIL hold times
      - Use detach() for expensive operations
      - Measure optimization impact
    enforcement: GIL profiling, performance benchmarks

  - name: Memory Efficiency
    description: Plugins must not consume excessive memory
    guidance: |
      - Profile plugin memory usage
      - Clean up temporary data
      - Use streaming where possible
      - Monitor for memory leaks
      - Document memory requirements
    enforcement: Memory profiling tests

  # Testing & Validation Rules
  - name: Plugin Testing Framework
    description: Test all plugin implementations
    guidance: |
      - Unit tests for plugin logic
      - Integration tests with registry
      - Error handling tests
      - Thread safety tests
      - Performance tests
    enforcement: Test coverage requirements (>90%)

  - name: Mock Plugin Testing
    description: Use mock plugins for framework testing
    guidance: |
      - Create test implementations of each trait
      - Test framework with mock plugins
      - Verify plugin lifecycle
      - Verify registry operations
      - Verify fallback behavior
    enforcement: Mock plugin test suite

  - name: Real Plugin Testing
    description: Test with actual built-in plugins
    guidance: |
      - Register and use built-in plugins
      - Verify extractor functionality
      - Test OCR backends
      - Test post-processors
      - Verify end-to-end integration
    enforcement: Integration test suite

  # Documentation & Communication Rules
  - name: Plugin Development Guide
    description: Provide comprehensive plugin development documentation
    guidance: |
      - Plugin trait definitions documented
      - Example implementations for each type
      - Configuration schema documented
      - Error handling patterns documented
      - Performance considerations documented
    enforcement: Documentation review, example code verification

  - name: API Stability
    description: Maintain stable plugin API across versions
    guidance: |
      - Plugin traits are public and stable
      - Breaking changes require major version
      - Deprecation notices provided
      - Migration guides for breaking changes
      - Backward compatibility maintained
    enforcement: Version policy enforcement, stability tests

  - name: Plugin Compatibility
    description: Document plugin compatibility requirements
    guidance: |
      - Minimum Kreuzberg version
      - Required Rust features
      - Python version requirements
      - External dependency requirements
      - Compatibility matrix documentation
    enforcement: Compatibility documentation, testing

  - name: Performance Documentation
    description: Document plugin performance characteristics
    guidance: |
      - Typical execution times
      - Resource requirements
      - Scalability characteristics
      - Optimization recommendations
      - Benchmark results
    enforcement: Performance documentation, benchmarks

  - name: Troubleshooting Guides
    description: Provide troubleshooting for common plugin issues
    guidance: |
      - Plugin registration failures
      - Plugin selection issues
      - Performance problems
      - GIL management issues
      - Language support issues
    enforcement: Troubleshooting guide updates
