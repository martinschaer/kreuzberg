rules:
  # Architecture & Design Rules
  - name: Single Responsibility
    description: Each component in extraction pipeline has focused responsibility
    guidance: |
      - MIME detection handles format identification only
      - Extractor selection handles routing to appropriate handler
      - Extractors implement extraction for specific format
      - Post-processors enhance results
      - Cache manager handles persistence
    enforcement: Code review verifies separation of concerns

  - name: Error Handling Protocol
    description: All extraction operations must handle errors gracefully
    guidance: |
      - Document failures with error context
      - Implement fallback extraction chains
      - Preserve partial results when possible
      - Return structured error information
      - Log errors with sufficient detail for debugging
    enforcement: Tests verify fallback behavior with corrupted documents

  - name: Configuration Cascade
    description: Use single ExtractionConfig for all extraction behavior control
    guidance: |
      - All extractors respect ExtractionConfig settings
      - Config changes don't require code modifications
      - Different extractors may use different config sections
      - Validate config values before extraction
      - Document config impact on output
    enforcement: Config schema validation, extractor tests with various configs

  - name: Cache-First Philosophy
    description: Check cache before expensive extraction operations
    guidance: |
      - Use content-based hash for cache keys
      - Check cache on every extraction request
      - Invalidate cache when config changes
      - Return cached results with metadata
      - Monitor cache hit rates
    enforcement: Performance testing verifies cache benefits

  - name: Async/Await Consistency
    description: Use async extraction APIs for non-blocking I/O
    guidance: |
      - Primary APIs are async (extract_file, extract_bytes)
      - Synchronous wrappers use global Tokio runtime
      - No blocking in async contexts
      - Batch operations use concurrent execution
      - Properly handle cancellation and timeouts
    enforcement: Static analysis detects blocking in async

  # MIME Type & Format Rules
  - name: Correct MIME Detection
    description: Reliably identify document formats
    guidance: |
      - Check file extension first (fast path)
      - Read magic bytes for format verification
      - Fall back to content analysis if ambiguous
      - Support legacy format detection and conversion
      - Return conservative MIME types for fallback
    enforcement: Unit tests for each MIME type; integration tests with real documents

  - name: Format Conversion Before Extraction
    description: Convert legacy Office formats before processing
    guidance: |
      - Detect legacy DOC, PPT formats
      - Convert to DOCX, PPTX via LibreOffice
      - Track conversion results
      - Fall back to legacy extractor if conversion fails
      - Document conversion behavior
    enforcement: Tests verify conversion and fallback

  - name: Extractor Fallback Chain
    description: Implement robust fallback when primary extraction fails
    guidance: |
      - Select highest-priority extractor for MIME type
      - On failure, try next-priority extractor
      - Continue chain until success or all extractors fail
      - Preserve error information from each attempt
      - Batch operations continue with partial results
    enforcement: Integration tests with failing extractors

  # Performance & Optimization Rules
  - name: Telemetry & Observability
    description: Record extraction telemetry for debugging and optimization
    guidance: |
      - Use OpenTelemetry spans for extraction operations
      - Record file format, size, duration
      - Include error details in error events
      - Sanitize file paths (filename only, no full path)
      - Track cache hits/misses
    enforcement: Telemetry output verified in tests

  - name: Concurrent Batch Processing
    description: Optimize batch extraction with concurrency
    guidance: |
      - Estimate appropriate worker pool size
      - Use Arc for shared state
      - Handle per-document errors independently
      - Continue processing on individual failures
      - Return results maintaining input order
    enforcement: Concurrency tests, performance benchmarks

  - name: Memory Efficiency
    description: Minimize memory footprint during extraction
    guidance: |
      - Stream large PDFs when possible
      - Don't load entire documents into memory
      - Clear temporary buffers promptly
      - Use Arc for shared data structures
      - Monitor memory usage in long-running operations
    enforcement: Memory profiling tests for large documents

  # Compatibility & Stability Rules
  - name: Backward Compatibility
    description: Maintain API stability across versions
    guidance: |
      - Don't change ExtractionResult structure without major version
      - Support multiple config versions
      - Document deprecations clearly
      - Provide migration paths for breaking changes
      - Test with legacy client code
    enforcement: Version policy in CHANGELOG, compatibility tests

  - name: Format Support Stability
    description: Maintain consistent extraction quality for supported formats
    guidance: |
      - Test extraction quality regularly
      - Alert on regressions
      - Document known limitations
      - Provide workarounds for edge cases
      - Track format support matrix
    enforcement: Regression tests, format coverage matrix

  - name: Cross-Platform Compatibility
    description: Ensure extraction works consistently across platforms
    guidance: |
      - Test on Linux, macOS, Windows
      - Handle platform-specific path issues
      - Use platform-appropriate tools (LibreOffice)
      - Document platform-specific behavior
      - Handle platform limitations
    enforcement: CI/CD tests on multiple platforms

  # Integration & Interoperability Rules
  - name: Plugin System Integration
    description: Use plugin system for format extensibility
    guidance: |
      - Register built-in extractors as plugins
      - Support custom extractor registration
      - Use priority system for extractor selection
      - Document plugin interface clearly
      - Provide example implementations
    enforcement: Plugin system tests, example code

  - name: OCR Integration
    description: Delegate image/embedded image extraction to OCR domain
    guidance: |
      - Route image documents to OCR subsystem
      - Use OCR results in overall extraction
      - Pass image configuration to OCR
      - Handle OCR failures gracefully
      - Cache OCR results
    enforcement: Integration tests with image documents

  - name: Post-Processing Pipeline
    description: Apply post-processors to enhance extraction results
    guidance: |
      - Apply configured post-processors sequentially
      - Pass ExtractionConfig to post-processors
      - Handle post-processor failures
      - Maintain result structure
      - Document post-processor behavior
    enforcement: Post-processor tests, result validation

  # Testing & Validation Rules
  - name: Comprehensive Test Coverage
    description: Test all extraction code paths
    guidance: |
      - Unit tests for MIME detection
      - Unit tests for each extractor
      - Integration tests for full extraction pipeline
      - Error handling tests (corrupted documents)
      - Performance benchmarks
      - Format-specific test documents
    enforcement: Coverage targets (>90%), CI/CD test requirements

  - name: Document Extraction Testing
    description: Test actual document extraction quality
    guidance: |
      - Test with real documents in various formats
      - Verify metadata extraction
      - Validate content accuracy
      - Test table extraction
      - Test image preservation
      - Test language detection
    enforcement: Quarterly extraction quality assessment

  - name: Edge Case Handling
    description: Handle unusual but valid document characteristics
    guidance: |
      - Empty documents
      - Very large documents (streaming)
      - Unusual character encodings
      - Documents with no text
      - Extremely complex layouts
      - Encrypted/password-protected documents
    enforcement: Edge case test suite

  # Documentation & Communication Rules
  - name: Clear Error Messages
    description: Provide actionable error information
    guidance: |
      - Include error type and root cause
      - Suggest corrective actions
      - Reference documentation
      - Include context (filename, format)
      - Make errors grep-friendly for logging
    enforcement: Error message review, user feedback

  - name: API Documentation
    description: Maintain clear, complete API documentation
    guidance: |
      - Document all public functions
      - Provide usage examples
      - Document configuration options
      - Explain error scenarios
      - Keep docs synchronized with code
    enforcement: Doc generation and validation

  - name: Change Notification
    description: Communicate significant changes
    guidance: |
      - Document breaking changes
      - Provide deprecation notices
      - Offer migration guides
      - Release notes for new features
      - Announce performance changes
    enforcement: CHANGELOG updates, release notes
