rules:
  # Backend Architecture Rules
  - name: Pluggable Backend Architecture
    description: OCR backends must be interchangeable and selectable
    guidance: |
      - Implement OcrBackend trait for all backends
      - Support Tesseract, EasyOCR, PaddleOCR natively
      - Enable custom backend registration
      - Document backend capabilities
      - Use priority system for backend selection
    enforcement: New backend implementations must implement full trait

  - name: Backend Independence
    description: Backends must not depend on each other
    guidance: |
      - Each backend has independent initialization
      - Failures in one backend don't affect others
      - Shared caching doesn't create backend coupling
      - Languages configurable per backend
      - Graceful degradation if backend unavailable
    enforcement: Backend tests run independently

  - name: Tesseract Native Integration
    description: Use native Tesseract via C FFI for performance
    guidance: |
      - Use kreuzberg-tesseract C bindings directly
      - Avoid additional language bindings (Python)
      - Support all PSM modes (0-13)
      - Maintain hOCR output for table reconstruction
      - Profile performance and optimize C interaction
    enforcement: Performance benchmarks, C FFI safety review

  - name: Python Backend Support
    description: Enable EasyOCR/PaddleOCR via Python plugin interface
    guidance: |
      - Wrap Python backends via PyO3 FFI
      - Manage GIL safely for async execution
      - Cache Python object references
      - Translate Python exceptions to Rust errors
      - Support configurable model loading
    enforcement: Python backend tests, GIL audits

  # Image Processing Rules
  - name: Smart Preprocessing
    description: Apply preprocessing conditionally based on image analysis
    guidance: |
      - Analyze image before preprocessing
      - Upscale low-resolution images (< 150 DPI)
      - Downsample extremely high-resolution images
      - Apply noise reduction only if detected
      - Apply contrast enhancement only if needed
      - Skip preprocessing for quality images
    enforcement: Preprocessing impact metrics in results

  - name: Preprocessing Pipeline Consistency
    description: Apply preprocessing consistently across all images
    guidance: |
      - Define standard preprocessing pipeline
      - Make pipeline configurable via ImagePreprocessingConfig
      - Order operations for efficiency and effectiveness
      - Document each preprocessing step
      - Test on diverse image types
    enforcement: Preprocessing tests with various image qualities

  - name: Deskewing Accuracy
    description: Correct text angle errors reliably
    guidance: |
      - Detect text angle automatically
      - Support manual angle specification
      - Verify deskew results
      - Handle edge cases (very skewed text)
      - Measure impact on OCR accuracy
    enforcement: Deskew tests with pre-skewed documents

  - name: Format-Specific Preprocessing
    description: Tailor preprocessing to image format characteristics
    guidance: |
      - PNG: Preserve transparency, optimize for digital
      - JPG: Handle compression artifacts, color space
      - TIFF: Support multi-page, manage resolution
      - WebP: Modern format with efficiency benefits
      - Grayscale: Different enhancement than color
    enforcement: Format-specific preprocessing tests

  # OCR Processing Rules
  - name: Result Caching Correctness
    description: Cache OCR results reliably and invalidate appropriately
    guidance: |
      - Use content hash for cache keys (not filename)
      - Include preprocessing config in cache key
      - Include OCR backend and config in cache key
      - Validate cache entries match current config
      - Clear cache when major config changes
    enforcement: Cache consistency tests, cache key validation

  - name: hOCR Parsing Fidelity
    description: Extract all relevant information from hOCR format
    guidance: |
      - Parse bounding box coordinates accurately
      - Extract confidence scores per word
      - Preserve formatting information
      - Track character-level position data
      - Validate hOCR XML structure
    enforcement: hOCR parsing tests with real Tesseract output

  - name: Confidence Score Tracking
    description: Track OCR confidence at appropriate granularity
    guidance: |
      - Record confidence per word
      - Support confidence per paragraph
      - Calculate average confidence
      - Flag low-confidence regions
      - Use for result filtering
    enforcement: Confidence score validation in results

  - name: Language Detection Accuracy
    description: Reliably identify text languages from OCR
    guidance: |
      - Detect language from OCR output
      - Support multi-language documents
      - Handle script mixing (Latin + CJK)
      - Fall back to config-specified languages
      - Document language detection limitations
    enforcement: Language detection tests on polyglot docs

  # Table Reconstruction Rules
  - name: Table Detection Accuracy
    description: Reliably identify and extract table structure
    guidance: |
      - Detect tables from hOCR bounding boxes
      - Reconstruct table cells accurately
      - Preserve merged cell information
      - Handle complex table layouts
      - Format as Markdown for readability
    enforcement: Table extraction tests on complex layouts

  - name: Cell Boundary Detection
    description: Accurately determine table cell boundaries
    guidance: |
      - Use spatial clustering on word positions
      - Detect row and column boundaries
      - Handle varying column widths
      - Preserve cell alignment
      - Validate cell detection results
    enforcement: Cell detection tests with diverse table types

  - name: Table to Markdown Conversion
    description: Convert tables to clean Markdown format
    guidance: |
      - Generate valid Markdown tables
      - Preserve cell content and alignment
      - Escape special characters in cells
      - Handle cell content spanning
      - Maintain table structure in output
    enforcement: Markdown table validation, readability review

  # Performance & Resource Rules
  - name: Async Execution Requirement
    description: All OCR operations must support async execution
    guidance: |
      - Implement async OcrBackend trait
      - Use tokio::task::spawn_blocking for sync Python
      - Never block the async runtime
      - Support concurrent image processing
      - Handle timeouts gracefully
    enforcement: Async execution tests, runtime analysis

  - name: Resource Management
    description: Manage OCR resource allocation efficiently
    guidance: |
      - Share OCR processor instance across calls
      - Limit concurrent OCR jobs (configurable pool)
      - Clean up temporary data promptly
      - Monitor memory usage
      - Handle resource exhaustion
    enforcement: Memory profiling, resource leak tests

  - name: Batch Processing Optimization
    description: Optimize batch OCR operations
    guidance: |
      - Process images concurrently
      - Share preprocessing resources
      - Use worker pool for efficiency
      - Maintain result ordering
      - Handle per-image failures independently
    enforcement: Concurrency benchmarks, batch tests

  - name: Cache Performance
    description: Ensure caching provides measurable benefits
    guidance: |
      - Measure cache hit rates regularly
      - Monitor cache storage size
      - Benchmark cache lookup times (target: <1ms)
      - Analyze hit rate trends
      - Adjust cache configuration based on metrics
    enforcement: Cache performance monitoring, quarterly reports

  # Language & Configuration Rules
  - name: Language Pack Validation
    description: Verify Tesseract language packs before use
    guidance: |
      - Check language pack installation
      - Validate language pack integrity
      - Provide helpful error messages
      - Suggest language pack installation
      - Handle missing languages gracefully
    enforcement: Language validation tests, installation verification

  - name: Multi-Language Support
    description: Handle documents with mixed languages
    guidance: |
      - Support language-per-document specification
      - Support language-per-region specification
      - Detect language changes mid-document
      - Optimize for polyglot documents
      - Test with multilingual documents
    enforcement: Multilingual document tests

  - name: PSM Mode Configuration
    description: Optimize PSM mode selection for document types
    guidance: |
      - Provide sensible PSM defaults
      - Allow per-document PSM override
      - Support region-specific PSM modes
      - Document PSM mode meanings
      - Test all PSM modes
    enforcement: PSM mode tests with various document types

  - name: Configuration Cascade
    description: Apply OCR configuration consistently
    guidance: |
      - TesseractConfig controls all OCR behavior
      - ImagePreprocessingConfig controls preprocessing
      - OcrConfig cascades from ExtractionConfig
      - Config overrides work hierarchically
      - Validate config values
    enforcement: Config validation tests

  # Error Handling & Resilience Rules
  - name: Graceful Backend Degradation
    description: Continue operation when backends fail
    guidance: |
      - Catch backend exceptions
      - Try next-priority backend on failure
      - Return partial results when possible
      - Document backend failures
      - Retry with alternative backend
    enforcement: Backend failure tests, degradation verification

  - name: Image Quality Handling
    description: Handle diverse image qualities robustly
    guidance: |
      - Process blurry images with preprocessing
      - Handle very low-resolution images
      - Manage noisy/degraded images
      - Support inverted/negative images
      - Handle unusual color spaces
    enforcement: Image quality tests, preprocessing benchmarks

  - name: Error Information Preservation
    description: Provide detailed error context for debugging
    guidance: |
      - Include image characteristics in errors
      - Record which backend failed
      - Preserve OCR output even on partial failure
      - Log configuration used
      - Track error frequency per backend
    enforcement: Error reporting tests, logging verification

  # Testing & Validation Rules
  - name: Comprehensive Backend Testing
    description: Test all OCR backends thoroughly
    guidance: |
      - Unit tests for each backend
      - Integration tests with real images
      - Accuracy benchmarks vs. ground truth
      - Performance profiling
      - Error handling tests
    enforcement: Backend test suite requirements, CI/CD verification

  - name: Preprocessing Effectiveness
    description: Validate preprocessing improves results
    guidance: |
      - Measure accuracy before/after preprocessing
      - Benchmark preprocessing overhead
      - Test on diverse image qualities
      - Document preprocessing impact
      - Optimize preprocessing pipeline
    enforcement: Preprocessing benchmarks, accuracy comparisons

  - name: Language Support Coverage
    description: Maintain language support matrix
    guidance: |
      - Document supported languages per backend
      - Test each language support claim
      - Track language support changes
      - Identify unsupported edge cases
      - Provide language-specific examples
    enforcement: Language matrix documentation, test coverage

  - name: Integration Testing
    description: Test OCR integration with extraction pipeline
    guidance: |
      - Test image document extraction
      - Test embedded image handling
      - Test OCR result integration
      - Verify caching works end-to-end
      - Test error propagation
    enforcement: Integration test suite, end-to-end tests

  # Documentation & Communication Rules
  - name: Backend Documentation
    description: Document OCR backend capabilities and limitations
    guidance: |
      - List supported languages
      - Document performance characteristics
      - Explain PSM mode usage
      - Provide configuration examples
      - Discuss accuracy expectations
    enforcement: Documentation reviews, user feedback

  - name: Performance Expectations
    description: Set realistic performance expectations
    guidance: |
      - Document typical processing times
      - Explain factors affecting performance
      - Provide optimization guidance
      - Show caching benefits
      - Benchmark on standard images
    enforcement: Performance documentation, accuracy verification

  - name: Troubleshooting Guides
    description: Provide troubleshooting for common OCR issues
    guidance: |
      - Low OCR accuracy → preprocessing options
      - Missing languages → installation steps
      - Slow performance → caching benefits
      - Table detection failures → PSM mode tuning
      - Backend selection → capability matching
    enforcement: Troubleshooting guide updates, user support

  - name: Change Communication
    description: Communicate backend changes clearly
    guidance: |
      - Release notes for new backends
      - Deprecation notices for old backends
      - Performance change announcements
      - Configuration change migration guides
      - API stability commitments
    enforcement: CHANGELOG updates, migration guides
