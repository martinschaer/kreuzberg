version: "3"

includes:
  _cfg:
    taskfile: ../config/vars.yml
    internal: true
  _platforms:
    taskfile: ../config/platforms.yml
    internal: true

vars:
  DOTNET_VERSION: "8.0"

tasks:
  # Installation
  install:
    desc: Restore C# dependencies
    dir: packages/csharp
    cmds:
      - dotnet restore Kreuzberg/Kreuzberg.csproj
      - dotnet restore Kreuzberg.Tests/Kreuzberg.Tests.csproj
      - dotnet restore Benchmark/Benchmark.csproj

  # Build Tasks
  build:
    desc: Build C# binding and benchmarks (depends on Rust FFI)
    dir: packages/csharp
    cmds:
      - dotnet restore
      - dotnet build Kreuzberg/Kreuzberg.csproj -c Release
      - dotnet build Benchmark/Benchmark.csproj -c Release

  build:dev:
    desc: Build C# binding in debug mode
    dir: packages/csharp
    cmds:
      - dotnet restore
      - dotnet build Kreuzberg/Kreuzberg.csproj -c Debug

  build:release:
    desc: Build C# binding in release mode (optimized)
    dir: packages/csharp
    cmds:
      - dotnet restore
      - dotnet build Kreuzberg/Kreuzberg.csproj -c Release

  build:ci:
    desc: Build C# binding in CI mode
    dir: packages/csharp
    cmds:
      - dotnet restore
      - dotnet build Kreuzberg/Kreuzberg.csproj -c Release

  # Test Tasks
  test:
    desc: Run C# tests
    cmds:
      - cmd: bash scripts/csharp/test.sh
        platforms: [linux, darwin]
      - cmd: cd packages/csharp && dotnet test Kreuzberg.Tests/Kreuzberg.Tests.csproj -c Release
        platforms: [windows]

  test:ci:
    desc: Run C# tests in CI mode
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: "true"
    cmds:
      - cmd: bash scripts/csharp/test.sh
        platforms: [linux, darwin]
      - cmd: cd packages/csharp && dotnet test Kreuzberg.Tests/Kreuzberg.Tests.csproj -c Release
        platforms: [windows]

  test:verbose:
    desc: Run C# tests with verbose output
    dir: packages/csharp
    cmds:
      - dotnet test Kreuzberg.Tests/Kreuzberg.Tests.csproj -c Release --verbosity detailed

  # Linting Tasks
  lint:
    desc: Lint C# code for style violations with auto-fix (dotnet format)
    dir: packages/csharp
    cmds:
      - dotnet format Kreuzberg/Kreuzberg.csproj
      - dotnet format Kreuzberg.Tests/Kreuzberg.Tests.csproj
      - dotnet format Benchmark/Benchmark.csproj

  lint:check:
    desc: Check C# code style violations without modifications (dotnet format verify)
    dir: packages/csharp
    cmds:
      - dotnet format Kreuzberg/Kreuzberg.csproj --verify-no-changes
      - dotnet format Kreuzberg.Tests/Kreuzberg.Tests.csproj --verify-no-changes
      - dotnet format Benchmark/Benchmark.csproj --verify-no-changes

  # Formatting Tasks
  format:
    desc: Format C# code with automatic style corrections (dotnet format)
    dir: packages/csharp
    cmds:
      - dotnet format Kreuzberg/Kreuzberg.csproj
      - dotnet format Kreuzberg.Tests/Kreuzberg.Tests.csproj
      - dotnet format Benchmark/Benchmark.csproj

  format:check:
    desc: Check C# code formatting without modifications (dotnet format verify)
    dir: packages/csharp
    cmds:
      - dotnet format Kreuzberg/Kreuzberg.csproj --verify-no-changes
      - dotnet format Kreuzberg.Tests/Kreuzberg.Tests.csproj --verify-no-changes
      - dotnet format Benchmark/Benchmark.csproj --verify-no-changes

  # Cleanup
  clean:
    desc: Clean C# build artifacts
    dir: packages/csharp
    cmds:
      - python -c "import shutil; [shutil.rmtree(d, ignore_errors=True) for d in ['bin', 'obj', '.vs']]"
      - dotnet clean

  # Dependency Management
  update:
    desc: Update/restore C# dependencies
    dir: packages/csharp
    cmds:
      - echo "Updating C# dependencies..."
      - dotnet restore Kreuzberg/Kreuzberg.csproj
      - dotnet restore Kreuzberg.Tests/Kreuzberg.Tests.csproj
      - dotnet restore Benchmark/Benchmark.csproj
      - dotnet package-reference update

  # E2E Tests
  e2e:generate:
    desc: Generate C# E2E tests from fixtures
    cmds:
      - cmd: bash scripts/task/e2e-generate.sh csharp
        platforms: [linux, darwin]
      - cmd: echo "E2E generation not yet supported on Windows - use WSL or CI"
        platforms: [windows]

  e2e:lint:
    desc: Lint C# E2E code
    cmds:
      - cmd: bash -c "cd e2e/csharp && dotnet format --verify-no-changes"
        platforms: [linux, darwin]
      - cmd: cd e2e/csharp && dotnet format --verify-no-changes
        platforms: [windows]

  e2e:test:
    desc: Run C# E2E tests
    cmds:
      - cmd: bash scripts/e2e/csharp/test.sh
        platforms: [linux, darwin]
      - cmd: cd e2e/csharp && dotnet test -c Release
        platforms: [windows]

  e2e:verify:
    desc: Regenerate and validate C# E2E suite (generate + lint + test)
    cmds:
      - task: e2e:generate
      - task: e2e:lint
      - task: e2e:test
