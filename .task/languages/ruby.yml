version: "3"

includes:
  _cfg:
    taskfile: ../config/vars.yml
    internal: true
  _platforms:
    taskfile: ../config/platforms.yml
    internal: true

vars:
  BUNDLE: bundle

tasks:
  # Installation
  install:
    desc: Install Ruby dependencies
    dir: packages/ruby
    cmds:
      - "{{.BUNDLE}} install"

  setup:
    desc: Alias for install
    dir: packages/ruby
    cmds:
      - task: ruby:install

  # Build Tasks
  build:
    desc: Build Ruby native extension (uses {{.BUILD_PROFILE}})
    dir: packages/ruby
    cmds:
      - "{{.BUNDLE}} exec rake compile"

  build:dev:
    desc: Build Ruby native extension in debug mode
    dir: packages/ruby
    cmds:
      - "{{.BUNDLE}} exec rake compile"

  build:release:
    desc: Build Ruby native extension in release mode (optimized)
    dir: packages/ruby
    env:
      CFLAGS: "-O3"
      LDFLAGS: "-s"
    cmds:
      - "{{.BUNDLE}} exec rake compile"

  build:ci:
    desc: Build Ruby native extension in CI mode
    dir: packages/ruby
    env:
      CFLAGS: "-O3 -g"
    cmds:
      - "{{.BUNDLE}} exec rake compile"

  # Test Tasks
  test:
    desc: Run Ruby tests
    dir: packages/ruby
    cmds:
      - "{{.BUNDLE}} exec rspec"

  test:ci:
    desc: Run Ruby tests in CI mode with env setup
    dir: packages/ruby
    cmds:
      - "{{.BUNDLE}} exec rspec"

  test:verbose:
    desc: Run Ruby tests with detailed output
    dir: packages/ruby
    cmds:
      - "{{.BUNDLE}} exec rspec --format documentation --color"

  # Linting Tasks
  lint:
    desc: Auto-fix Ruby code linting (rubocop + steep)
    dir: packages/ruby
    cmds:
      - "{{.BUNDLE}} exec rubocop --config .rubocop.yml --autocorrect-all"
      - "{{.BUNDLE}} exec steep check"

  lint:check:
    desc: Check Ruby code linting without modifications (rubocop + steep, no fixes)
    dir: packages/ruby
    cmds:
      - "{{.BUNDLE}} exec rubocop --config .rubocop.yml"
      - "{{.BUNDLE}} exec steep check"

  # Formatting Tasks
  format:
    desc: Format Ruby code with modifications (rubocop)
    dir: packages/ruby
    cmds:
      - "{{.BUNDLE}} exec rubocop --config .rubocop.yml --autocorrect-all"

  format:check:
    desc: Check Ruby code formatting without modifications (rubocop)
    dir: packages/ruby
    cmds:
      - "{{.BUNDLE}} exec rubocop --config .rubocop.yml"

  # Type checking
  typecheck:
    desc: Run steep type checking
    dir: packages/ruby
    cmds:
      - "{{.BUNDLE}} exec steep check"

  # REPL
  console:
    desc: Open Ruby console with Kreuzberg loaded
    dir: packages/ruby
    cmds:
      - "{{.BUNDLE}} exec pry -r ./lib/kreuzberg"

  # Cleanup
  clean:
    desc: Clean Ruby build artifacts
    dir: packages/ruby
    cmds:
      - python -c "import shutil, glob, os; shutil.rmtree('tmp', ignore_errors=True); [os.remove(f) for f in glob.glob('ext/kreuzberg/*.o') + glob.glob('ext/kreuzberg/*.so')]"
      - python -c "import shutil, os; [shutil.rmtree(os.path.join(r, d), ignore_errors=True) for r, dirs, _ in os.walk('.') for d in dirs if d == '.steep']"

  # Dependency Management
  update:
    desc: Update Ruby dependencies
    dir: packages/ruby
    cmds:
      - echo "Updating Ruby dependencies..."
      - "{{.BUNDLE}} update --all"

  # E2E Tests
  e2e:generate:
    desc: Generate Ruby E2E tests from fixtures
    cmds:
      - cmd: bash scripts/task/e2e-generate.sh ruby
        platforms: [linux, darwin]
      - cmd: echo "E2E generation not yet supported on Windows - use WSL or CI"
        platforms: [windows]

  e2e:test:
    desc: Run Ruby E2E tests
    dir: e2e/ruby
    cmds:
      - "{{.BUNDLE}} exec rspec"

  e2e:lint:
    desc: Lint Ruby E2E code
    dir: e2e/ruby
    cmds:
      - "{{.BUNDLE}} exec rubocop --config .rubocop.yml"
      - "{{.BUNDLE}} exec steep check"

  e2e:verify:
    desc: Regenerate and validate Ruby E2E suite (generate + lint + test)
    cmds:
      - task: e2e:generate
      - task: e2e:lint
      - task: e2e:test
